<div class="page">
  <header class="header">
    <h1>POC Redmine API</h1>
    <p>Crear tickets y consultar listados por usuario.</p>
  </header>

  <section class="card">
    <h2>Configuraci√≥n</h2>
    <div class="grid">
      <label>
        Base URL
        <input
          type="text"
          [(ngModel)]="baseUrl"
          placeholder="https://redmine.tu-dominio.com"
          name="baseUrl"
          value="http://localhost:3000/issues.json"
        />
      </label>
      <label>
        API Key
        <input
          type="text"
          [(ngModel)]="apiKey"
          placeholder="X-Redmine-API-Key"
          name="apiKey"
        />
      </label>
    </div>
    <button class="test-btn" (click)="testConnection()" [disabled]="isTesting">
      {{ isTesting ? "Probando..." : "üîå Probar conexi√≥n" }}
    </button>
    <div
      class="messages"
      *ngIf="errorMessage || successMessage || connectionInfo"
    >
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
      <p class="info" *ngIf="connectionInfo">{{ connectionInfo }}</p>
    </div>
  </section>

  <section class="card">
    <h2>Proyectos disponibles</h2>
    <p>Consulta los proyectos para obtener el ID o identifier que necesitas.</p>
    
    <button class="secondary" (click)="fetchProjects()" [disabled]="isLoadingProjects">
      {{ isLoadingProjects ? "Cargando..." : "üìã Listar proyectos" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !projects.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && projects.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="projects.length">
      <article class="project" *ngFor="let project of projects">
        <div class="project__header">
          <strong>{{ project.name }}</strong>
          <span class="badge">ID: {{ project.id }}</span>
        </div>
        <div class="project__details">
          <span><strong>Identifier:</strong> <code>{{ project.identifier }}</code></span>
          <span *ngIf="project.status !== undefined">
            <strong>Estado:</strong> {{ project.status === 1 ? 'Activo' : 'Cerrado' }}
          </span>
          <span *ngIf="project.is_public !== undefined">
            {{ project.is_public ? 'üåê P√∫blico' : 'üîí Privado' }}
          </span>
        </div>
        <p class="project__description" *ngIf="project.description">
          {{ project.description }}
        </p>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingProjects && projects.length === 0 && successMessage">
      <p>üì≠ No se encontraron proyectos disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Usuarios disponibles</h2>
    <p>Consulta los usuarios para obtener el ID que necesitas para asignar tickets.</p>
    
    <button class="secondary" (click)="fetchUsers()" [disabled]="isLoadingUsers">
      {{ isLoadingUsers ? "Cargando..." : "üë• Listar usuarios" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !users.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && users.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="users.length">
      <article class="user" *ngFor="let user of users">
        <div class="user__header">
          <strong>{{ user.name }}</strong>
          <span class="badge">ID: {{ user.id }}</span>
        </div>
        <div class="user__details">
          <span *ngIf="user.login"><strong>Login:</strong> <code>{{ user.login }}</code></span>
          <span *ngIf="user.mail"><strong>Email:</strong> {{ user.mail }}</span>
          <span *ngIf="user.status !== undefined">
            <strong>Estado:</strong> 
            <span [class.user-status--active]="user.status === 1" [class.user-status--locked]="user.status === 3">
              {{ user.status === 1 ? '‚úÖ Activo' : user.status === 3 ? 'üîí Bloqueado' : 'Inactivo' }}
            </span>
          </span>
        </div>
        <div class="user__meta" *ngIf="user.created_on || user.last_login_on">
          <span *ngIf="user.created_on"><strong>Creado:</strong> {{ user.created_on | date: 'short' }}</span>
          <span *ngIf="user.last_login_on"><strong>√öltimo login:</strong> {{ user.last_login_on | date: 'short' }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingUsers && users.length === 0 && successMessage">
      <p>üì≠ No se encontraron usuarios disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Prioridades disponibles</h2>
    <p>Consulta las prioridades disponibles para asignar a los tickets.</p>
    
    <button class="secondary" (click)="fetchPriorities()" [disabled]="isLoadingPriorities">
      {{ isLoadingPriorities ? "Cargando..." : "‚ö° Listar prioridades" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !priorities.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && priorities.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="priorities.length">
      <article class="priority" *ngFor="let priority of priorities">
        <div class="priority__header">
          <strong>{{ priority.name }}</strong>
          <span class="badge">ID: {{ priority.id }}</span>
          <span class="badge badge--default" *ngIf="priority.is_default">Por defecto</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingPriorities && priorities.length === 0 && successMessage">
      <p>üì≠ No se encontraron prioridades disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Categor√≠as del proyecto</h2>
    <p>Consulta las categor√≠as disponibles del proyecto seleccionado. <strong>Debes ingresar un Project ID primero.</strong></p>
    
    <button class="secondary" (click)="fetchCategories()" [disabled]="isLoadingCategories || !projectId">
      {{ isLoadingCategories ? "Cargando..." : "üìã Listar categor√≠as" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !categories.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="categories.length">
      <article class="category" *ngFor="let category of categories">
        <div class="category__header">
          <strong>{{ category.name }}</strong>
          <span class="badge">ID: {{ category.id }}</span>
        </div>
        <div class="category__details" *ngIf="category.assigned_to">
          <span><strong>Asignado a:</strong> {{ category.assigned_to.name }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingCategories && categories.length === 0 && successMessage">
      <p>üì≠ {{ successMessage }}</p>
    </div>
  </section>

  <section class="card">
    <h2>Trackers disponibles</h2>
    <p>Consulta los tipos de issue (Bug, Feature, Support, etc.) disponibles en Redmine.</p>
    
    <button class="secondary" (click)="fetchTrackers()" [disabled]="isLoadingTrackers">
      {{ isLoadingTrackers ? "Cargando..." : "üéØ Listar trackers" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !trackers.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && trackers.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="trackers.length">
      <article class="tracker" *ngFor="let tracker of trackers">
        <div class="tracker__header">
          <strong>{{ tracker.name }}</strong>
          <span class="badge">ID: {{ tracker.id }}</span>
        </div>
        <div class="tracker__details" *ngIf="tracker.default_status">
          <span><strong>Estado por defecto:</strong> {{ tracker.default_status.name }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingTrackers && trackers.length === 0 && successMessage">
      <p>üì≠ No se encontraron trackers disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Registrar ticket</h2>
    <div class="grid">
      <label>
        Project ID / Identifier
        <input
          type="text"
          [(ngModel)]="projectId"
          placeholder="1 o project-identifier"
          name="projectId"
        />
      </label>
      <label>
        Asignado a (opcional)
        <input
          type="text"
          [(ngModel)]="assignedToId"
          placeholder="ID del usuario"
          name="assignedToId"
        />
      </label>
      <label>
        Prioridad (opcional)
        <select [(ngModel)]="priorityId" name="priorityId">
          <option value="">-- Selecciona una prioridad --</option>
          <option *ngFor="let priority of priorities" [value]="priority.id">
            {{ priority.name }}{{ priority.is_default ? ' (Por defecto)' : '' }}
          </option>
        </select>
        <small *ngIf="!priorities.length">Haz clic en "‚ö° Listar prioridades" para cargar las opciones</small>
      </label>
      <label>
        Categor√≠a (opcional)
        <select [(ngModel)]="categoryId" name="categoryId">
          <option value="">-- Selecciona una categor√≠a --</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
        <small *ngIf="!categories.length">Ingresa el Project ID y haz clic en "üìã Listar categor√≠as"</small>
      </label>
      <label>
        Tracker (opcional)
        <select [(ngModel)]="trackerId" name="trackerId">
          <option value="">-- Selecciona un tracker --</option>
          <option *ngFor="let tracker of trackers" [value]="tracker.id">
            {{ tracker.name }}
          </option>
        </select>
        <small *ngIf="!trackers.length">Haz clic en "üéØ Listar trackers" para cargar las opciones</small>
      </label>
      <label class="span-2">
        Subject
        <input
          type="text"
          [(ngModel)]="subject"
          placeholder="T√≠tulo del ticket"
          name="subject"
        />
      </label>
      <label class="span-2">
        Description
        <textarea
          rows="4"
          [(ngModel)]="description"
          placeholder="Detalle del ticket"
          name="description"
        ></textarea>
      </label>
    </div>

    <div class="file-upload-section">
      <h3>Adjuntar archivos (opcional)</h3>
      <div class="file-input-wrapper">
        <input
          type="file"
          (change)="onFileSelect($event)"
          multiple
          #fileInput
          id="fileInput"
        />
        <label for="fileInput" class="file-label">
          üìé Seleccionar archivos
        </label>
        <span class="file-count" *ngIf="selectedFiles.length > 0">
          {{ selectedFiles.length }} archivo(s) seleccionado(s)
        </span>
      </div>

      <button 
        class="secondary" 
        (click)="uploadFiles()" 
        [disabled]="isUploadingFiles || selectedFiles.length === 0"
        *ngIf="selectedFiles.length > 0 && uploadedFiles.length === 0"
      >
        {{ isUploadingFiles ? "Subiendo..." : "üì§ Subir archivos" }}
      </button>

      <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
        <h4>Archivos listos para adjuntar:</h4>
        <div class="file-list">
          <div class="file-item" *ngFor="let file of uploadedFiles; let i = index">
            <span class="file-name">üìÑ {{ file.filename }}</span>
            <span class="file-type">{{ file.content_type }}</span>
            <button class="remove-btn" (click)="removeUploadedFile(i)" title="Remover archivo">
              ‚ùå
            </button>
          </div>
        </div>
      </div>
    </div>

    <button class="primary" (click)="createIssue()" [disabled]="isCreating">
      {{ isCreating ? "Creando..." : "Crear ticket" }}
    </button>
  </section>

  <section class="card">
    <h2>Consultar tickets</h2>

    <div class="filter-section">
      <h3>Filtros de b√∫squeda</h3>

      <div class="grid">
        <label>
          Tipo de consulta
          <select [(ngModel)]="filterType" name="filterType">
            <option value="author">Creados por usuario</option>
            <option value="assigned">Asignados a usuario</option>
            <option value="all">Todos (sin filtro de usuario)</option>
          </select>
        </label>

        <label *ngIf="filterType !== 'all'">
          Usuario ID
          <input
            type="text"
            [(ngModel)]="filterUserId"
            placeholder="me, ID num√©rico o vac√≠o"
            name="filterUserId"
          />
          <small
            >Usa "me" para ti mismo, un ID para otro usuario, o d√©jalo
            vac√≠o</small
          >
        </label>

        <label>
          Estado (opcional)
          <input
            type="text"
            [(ngModel)]="filterStatusId"
            placeholder="open, closed, * o ID"
            name="filterStatusId"
          />
          <small
            >"open" = abiertos, "closed" = cerrados, "*" = todos, o ID
            espec√≠fico</small
          >
        </label>

        <label>
          Project ID (opcional)
          <input
            type="text"
            [(ngModel)]="filterProjectId"
            placeholder="ID o identifier del proyecto"
            name="filterProjectId"
          />
        </label>

        <label>
          L√≠mite de resultados
          <input
            type="number"
            [(ngModel)]="limit"
            name="limit"
            min="1"
            max="100"
          />
        </label>
      </div>
    </div>

    <button class="secondary" (click)="fetchIssues()" [disabled]="isLoading">
      {{ isLoading ? "Consultando..." : "üîç Consultar tickets" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="issues.length">
      <article class="issue" *ngFor="let issue of issues">
        <div class="issue__header">
          <strong>#{{ issue.id }} - {{ issue.subject }}</strong>
          <div class="issue__actions">
            <button 
              class="detail-btn" 
              (click)="fetchIssueDetail(issue.id)" 
              [disabled]="isLoadingIssueDetail"
              title="Ver detalles"
            >
              üîç
            </button>
            <span
              class="status"
              [class.status--open]="
                (issue.status?.name?.toLowerCase() || '').includes('new') ||
                (issue.status?.name?.toLowerCase() || '').includes('open')
              "
              [class.status--closed]="
                (issue.status?.name?.toLowerCase() || '').includes('closed') ||
                (issue.status?.name?.toLowerCase() || '').includes('resolved')
              "
            >
              {{ issue.status?.name || "Sin estado" }}
            </span>
          </div>
        </div>
        <p class="issue__description" *ngIf="issue.description">
          {{ issue.description }}
        </p>
        <div class="issue__meta">
          <span><strong>Autor:</strong> {{ issue.author?.name || "N/A" }}</span>
          <span
            ><strong>Asignado:</strong>
            {{ issue.assigned_to?.name || "Sin asignar" }}</span
          >
          <span
            ><strong>Creado:</strong>
            {{ issue.created_on | date: "short" }}</span
          >
          <span *ngIf="issue.updated_on"
            ><strong>Actualizado:</strong>
            {{ issue.updated_on | date: "short" }}</span
          >
        </div>
      </article>
    </div>

    <div
      class="no-results"
      *ngIf="!isLoading && issues.length === 0 && successMessage"
    >
      <p>üì≠ No se encontraron tickets con los filtros aplicados.</p>
    </div>
  </section>
</div>

<!-- Modal de detalle de ticket -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()" *ngIf="selectedIssue">
    <div class="modal__header">
      <h2>Ticket #{{ selectedIssue.id }}</h2>
      <button class="close-btn" (click)="closeModal()">‚úñ</button>
    </div>

    <div class="modal__body">
      <!-- Informaci√≥n b√°sica -->
      <section class="modal-section">
        <h3>Informaci√≥n b√°sica</h3>
        <div class="info-grid">
          <div class="info-item">
            <strong>Subject:</strong>
            <span>{{ selectedIssue.subject }}</span>
          </div>
          <div class="info-item">
            <strong>Estado:</strong>
            <span class="badge badge--status">{{ selectedIssue.status?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Proyecto:</strong>
            <span>{{ selectedIssue.project?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Tracker:</strong>
            <span>{{ selectedIssue.tracker?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Prioridad:</strong>
            <span>{{ selectedIssue.priority?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Categor√≠a:</strong>
            <span>{{ selectedIssue.category?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Autor:</strong>
            <span>{{ selectedIssue.author?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <strong>Asignado a:</strong>
            <span>{{ selectedIssue.assigned_to?.name || 'Sin asignar' }}</span>
          </div>
          <div class="info-item">
            <strong>Creado:</strong>
            <span>{{ selectedIssue.created_on | date: 'medium' }}</span>
          </div>
          <div class="info-item">
            <strong>Actualizado:</strong>
            <span>{{ selectedIssue.updated_on | date: 'medium' }}</span>
          </div>
          <div class="info-item" *ngIf="selectedIssue.start_date">
            <strong>Fecha inicio:</strong>
            <span>{{ selectedIssue.start_date | date: 'short' }}</span>
          </div>
          <div class="info-item" *ngIf="selectedIssue.due_date">
            <strong>Fecha fin:</strong>
            <span>{{ selectedIssue.due_date | date: 'short' }}</span>
          </div>
          <div class="info-item" *ngIf="selectedIssue.estimated_hours">
            <strong>Horas estimadas:</strong>
            <span>{{ selectedIssue.estimated_hours }}h</span>
          </div>
          <div class="info-item" *ngIf="selectedIssue.spent_hours">
            <strong>Horas gastadas:</strong>
            <span>{{ selectedIssue.spent_hours }}h</span>
          </div>
          <div class="info-item" *ngIf="selectedIssue.done_ratio !== undefined">
            <strong>% Completado:</strong>
            <span>{{ selectedIssue.done_ratio }}%</span>
          </div>
        </div>
      </section>

      <!-- Descripci√≥n -->
      <section class="modal-section" *ngIf="selectedIssue.description">
        <h3>Descripci√≥n</h3>
        <div class="description-box">
          {{ selectedIssue.description }}
        </div>
      </section>

      <!-- Adjuntos -->
      <section class="modal-section" *ngIf="selectedIssue.attachments && selectedIssue.attachments.length > 0">
        <h3>Archivos adjuntos ({{ selectedIssue.attachments.length }})</h3>
        <div class="attachments-list">
          <div class="attachment-item" *ngFor="let attachment of selectedIssue.attachments">
            <div class="attachment-icon">üìÑ</div>
            <div class="attachment-info">
              <a [href]="attachment.content_url" target="_blank" class="attachment-name">
                {{ attachment.filename }}
              </a>
              <div class="attachment-meta">
                <span>{{ formatFileSize(attachment.filesize) }}</span>
                <span>‚Ä¢</span>
                <span>{{ attachment.author.name }}</span>
                <span>‚Ä¢</span>
                <span>{{ attachment.created_on | date: 'short' }}</span>
              </div>
              <p class="attachment-description" *ngIf="attachment.description">
                {{ attachment.description }}
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Observadores -->
      <section class="modal-section" *ngIf="selectedIssue.watchers && selectedIssue.watchers.length > 0">
        <h3>Observadores ({{ selectedIssue.watchers.length }})</h3>
        <div class="watchers-list">
          <span class="watcher-badge" *ngFor="let watcher of selectedIssue.watchers">
            üëÅÔ∏è {{ watcher.name }}
          </span>
        </div>
      </section>

      <!-- Subtareas -->
      <section class="modal-section" *ngIf="selectedIssue.children && selectedIssue.children.length > 0">
        <h3>Subtareas ({{ selectedIssue.children.length }})</h3>
        <div class="children-list">
          <div class="child-item" *ngFor="let child of selectedIssue.children">
            <strong>#{{ child.id }}</strong>
            <span>{{ child.subject }}</span>
            <span class="badge badge--small">{{ child.status?.name }}</span>
          </div>
        </div>
      </section>

      <!-- Historial (Journals) -->
      <section class="modal-section" *ngIf="selectedIssue.journals && selectedIssue.journals.length > 0">
        <h3>Historial ({{ selectedIssue.journals.length }} entradas)</h3>
        <div class="journals-list">
          <div class="journal-item" *ngFor="let journal of selectedIssue.journals">
            <div class="journal-header">
              <strong>{{ journal.user.name }}</strong>
              <span class="journal-date">{{ journal.created_on | date: 'medium' }}</span>
            </div>
            <div class="journal-notes" *ngIf="journal.notes">
              {{ journal.notes }}
            </div>
            <div class="journal-details" *ngIf="journal.details && journal.details.length > 0">
              <div class="detail-change" *ngFor="let detail of journal.details">
                <strong>{{ detail.name }}</strong> cambi√≥ de 
                <span class="old-value">{{ detail.old_value || '(vac√≠o)' }}</span> a 
                <span class="new-value">{{ detail.new_value || '(vac√≠o)' }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Relaciones -->
      <section class="modal-section" *ngIf="selectedIssue.relations && selectedIssue.relations.length > 0">
        <h3>Relaciones ({{ selectedIssue.relations.length }})</h3>
        <div class="relations-list">
          <div class="relation-item" *ngFor="let relation of selectedIssue.relations">
            <span class="badge badge--relation">{{ relation.relation_type }}</span>
            <span>Issue #{{ relation.issue_to_id }}</span>
            <span *ngIf="relation.delay">Delay: {{ relation.delay }} d√≠as</span>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
