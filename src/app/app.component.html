<div class="page">
  <header class="header">
    <h1>POC Redmine API</h1>
    <p>Crear tickets y consultar listados por usuario.</p>
  </header>

  <section class="card">
    <h2>Configuraci√≥n</h2>
    <div class="grid">
      <label>
        Base URL
        <input
          type="text"
          [(ngModel)]="baseUrl"
          placeholder="https://redmine.tu-dominio.com"
          name="baseUrl"
        />
      </label>
      <label>
        API Key
        <input
          type="password"
          [(ngModel)]="apiKey"
          placeholder="X-Redmine-API-Key"
          name="apiKey"
        />
      </label>
    </div>
    <button class="test-btn" (click)="testConnection()" [disabled]="isTesting">
      {{ isTesting ? "Probando..." : "üîå Probar conexi√≥n" }}
    </button>
    <div
      class="messages"
      *ngIf="errorMessage || successMessage || connectionInfo"
    >
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
      <p class="info" *ngIf="connectionInfo">{{ connectionInfo }}</p>
    </div>
  </section>

  <section class="card">
    <h2>Registrar ticket</h2>
    <div class="grid">
      <label>
        Project ID / Identifier
        <input
          type="text"
          [(ngModel)]="projectId"
          placeholder="1 o project-identifier"
          name="projectId"
        />
      </label>
      <label>
        Asignado a (opcional)
        <input
          type="text"
          [(ngModel)]="assignedToId"
          placeholder="ID del usuario"
          name="assignedToId"
        />
      </label>
      <label class="span-2">
        Subject
        <input
          type="text"
          [(ngModel)]="subject"
          placeholder="T√≠tulo del ticket"
          name="subject"
        />
      </label>
      <label class="span-2">
        Description
        <textarea
          rows="4"
          [(ngModel)]="description"
          placeholder="Detalle del ticket"
          name="description"
        ></textarea>
      </label>
    </div>
    <button class="primary" (click)="createIssue()" [disabled]="isCreating">
      {{ isCreating ? "Creando..." : "Crear ticket" }}
    </button>
  </section>

  <section class="card">
    <h2>Consultar tickets</h2>

    <div class="filter-section">
      <h3>Filtros de b√∫squeda</h3>

      <div class="grid">
        <label>
          Tipo de consulta
          <select [(ngModel)]="filterType" name="filterType">
            <option value="author">Creados por usuario</option>
            <option value="assigned">Asignados a usuario</option>
            <option value="all">Todos (sin filtro de usuario)</option>
          </select>
        </label>

        <label *ngIf="filterType !== 'all'">
          Usuario ID
          <input
            type="text"
            [(ngModel)]="filterUserId"
            placeholder="me, ID num√©rico o vac√≠o"
            name="filterUserId"
          />
          <small
            >Usa "me" para ti mismo, un ID para otro usuario, o d√©jalo
            vac√≠o</small
          >
        </label>

        <label>
          Estado (opcional)
          <input
            type="text"
            [(ngModel)]="filterStatusId"
            placeholder="open, closed, * o ID"
            name="filterStatusId"
          />
          <small
            >"open" = abiertos, "closed" = cerrados, "*" = todos, o ID
            espec√≠fico</small
          >
        </label>

        <label>
          Project ID (opcional)
          <input
            type="text"
            [(ngModel)]="filterProjectId"
            placeholder="ID o identifier del proyecto"
            name="filterProjectId"
          />
        </label>

        <label>
          L√≠mite de resultados
          <input
            type="number"
            [(ngModel)]="limit"
            name="limit"
            min="1"
            max="100"
          />
        </label>
      </div>
    </div>

    <button class="secondary" (click)="fetchIssues()" [disabled]="isLoading">
      {{ isLoading ? "Consultando..." : "üîç Consultar tickets" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="issues.length">
      <article class="issue" *ngFor="let issue of issues">
        <div class="issue__header">
          <strong>#{{ issue.id }} - {{ issue.subject }}</strong>
          <span
            class="status"
            [class.status--open]="
              (issue.status?.name?.toLowerCase() || '').includes('new') ||
              (issue.status?.name?.toLowerCase() || '').includes('open')
            "
            [class.status--closed]="
              (issue.status?.name?.toLowerCase() || '').includes('closed') ||
              (issue.status?.name?.toLowerCase() || '').includes('resolved')
            "
          >
            {{ issue.status?.name || "Sin estado" }}
          </span>
        </div>
        <p class="issue__description" *ngIf="issue.description">
          {{ issue.description }}
        </p>
        <div class="issue__meta">
          <span><strong>Autor:</strong> {{ issue.author?.name || "N/A" }}</span>
          <span
            ><strong>Asignado:</strong>
            {{ issue.assigned_to?.name || "Sin asignar" }}</span
          >
          <span
            ><strong>Creado:</strong>
            {{ issue.created_on | date: "short" }}</span
          >
          <span *ngIf="issue.updated_on"
            ><strong>Actualizado:</strong>
            {{ issue.updated_on | date: "short" }}</span
          >
        </div>
      </article>
    </div>

    <div
      class="no-results"
      *ngIf="!isLoading && issues.length === 0 && successMessage"
    >
      <p>üì≠ No se encontraron tickets con los filtros aplicados.</p>
    </div>
  </section>
</div>
