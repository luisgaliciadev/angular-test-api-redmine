<div class="page">
  <header class="header">
    <h1>POC Redmine API</h1>
    <p>Crear tickets y consultar listados por usuario.</p>
  </header>

  <section class="card">
    <h2>ConfiguraciÃ³n</h2>
    <div class="grid">
      <label>
        Base URL
        <input
          type="text"
          [(ngModel)]="baseUrl"
          placeholder="https://redmine.tu-dominio.com"
          name="baseUrl"
          value="http://localhost:3000/issues.json"
        />
      </label>
      <label>
        API Key
        <input
          type="text"
          [(ngModel)]="apiKey"
          placeholder="X-Redmine-API-Key"
          name="apiKey"
        />
      </label>
    </div>
    <button class="test-btn" (click)="testConnection()" [disabled]="isTesting">
      {{ isTesting ? "Probando..." : "ğŸ”Œ Probar conexiÃ³n" }}
    </button>
    <div
      class="messages"
      *ngIf="errorMessage || successMessage || connectionInfo"
    >
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
      <p class="info" *ngIf="connectionInfo">{{ connectionInfo }}</p>
    </div>
  </section>

  <section class="card">
    <h2>Proyectos disponibles</h2>
    <p>Consulta los proyectos para obtener el ID o identifier que necesitas.</p>
    
    <button class="secondary" (click)="fetchProjects()" [disabled]="isLoadingProjects">
      {{ isLoadingProjects ? "Cargando..." : "ğŸ“‹ Listar proyectos" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !projects.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && projects.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="projects.length">
      <article class="project" *ngFor="let project of projects">
        <div class="project__header">
          <strong>{{ project.name }}</strong>
          <span class="badge">ID: {{ project.id }}</span>
        </div>
        <div class="project__details">
          <span><strong>Identifier:</strong> <code>{{ project.identifier }}</code></span>
          <span *ngIf="project.status !== undefined">
            <strong>Estado:</strong> {{ project.status === 1 ? 'Activo' : 'Cerrado' }}
          </span>
          <span *ngIf="project.is_public !== undefined">
            {{ project.is_public ? 'ğŸŒ PÃºblico' : 'ğŸ”’ Privado' }}
          </span>
        </div>
        <p class="project__description" *ngIf="project.description">
          {{ project.description }}
        </p>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingProjects && projects.length === 0 && successMessage">
      <p>ğŸ“­ No se encontraron proyectos disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Usuarios disponibles</h2>
    <p>Consulta los usuarios para obtener el ID que necesitas para asignar tickets.</p>
    
    <button class="secondary" (click)="fetchUsers()" [disabled]="isLoadingUsers">
      {{ isLoadingUsers ? "Cargando..." : "ğŸ‘¥ Listar usuarios" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !users.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && users.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="users.length">
      <article class="user" *ngFor="let user of users">
        <div class="user__header">
          <strong>{{ user.name }}</strong>
          <span class="badge">ID: {{ user.id }}</span>
        </div>
        <div class="user__details">
          <span *ngIf="user.login"><strong>Login:</strong> <code>{{ user.login }}</code></span>
          <span *ngIf="user.mail"><strong>Email:</strong> {{ user.mail }}</span>
          <span *ngIf="user.status !== undefined">
            <strong>Estado:</strong> 
            <span [class.user-status--active]="user.status === 1" [class.user-status--locked]="user.status === 3">
              {{ user.status === 1 ? 'âœ… Activo' : user.status === 3 ? 'ğŸ”’ Bloqueado' : 'Inactivo' }}
            </span>
          </span>
        </div>
        <div class="user__meta" *ngIf="user.created_on || user.last_login_on">
          <span *ngIf="user.created_on"><strong>Creado:</strong> {{ user.created_on | date: 'short' }}</span>
          <span *ngIf="user.last_login_on"><strong>Ãšltimo login:</strong> {{ user.last_login_on | date: 'short' }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingUsers && users.length === 0 && successMessage">
      <p>ğŸ“­ No se encontraron usuarios disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Prioridades disponibles</h2>
    <p>Consulta las prioridades disponibles para asignar a los tickets.</p>
    
    <button class="secondary" (click)="fetchPriorities()" [disabled]="isLoadingPriorities">
      {{ isLoadingPriorities ? "Cargando..." : "âš¡ Listar prioridades" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !priorities.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && priorities.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="priorities.length">
      <article class="priority" *ngFor="let priority of priorities">
        <div class="priority__header">
          <strong>{{ priority.name }}</strong>
          <span class="badge">ID: {{ priority.id }}</span>
          <span class="badge badge--default" *ngIf="priority.is_default">Por defecto</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingPriorities && priorities.length === 0 && successMessage">
      <p>ğŸ“­ No se encontraron prioridades disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>CategorÃ­as del proyecto</h2>
    <p>Consulta las categorÃ­as disponibles del proyecto seleccionado. <strong>Debes ingresar un Project ID primero.</strong></p>
    
    <button class="secondary" (click)="fetchCategories()" [disabled]="isLoadingCategories || !projectId">
      {{ isLoadingCategories ? "Cargando..." : "ğŸ“‹ Listar categorÃ­as" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !categories.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="categories.length">
      <article class="category" *ngFor="let category of categories">
        <div class="category__header">
          <strong>{{ category.name }}</strong>
          <span class="badge">ID: {{ category.id }}</span>
        </div>
        <div class="category__details" *ngIf="category.assigned_to">
          <span><strong>Asignado a:</strong> {{ category.assigned_to.name }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingCategories && categories.length === 0 && successMessage">
      <p>ğŸ“­ {{ successMessage }}</p>
    </div>
  </section>

  <section class="card">
    <h2>Trackers disponibles</h2>
    <p>Consulta los tipos de issue (Bug, Feature, Support, etc.) disponibles en Redmine.</p>
    
    <button class="secondary" (click)="fetchTrackers()" [disabled]="isLoadingTrackers">
      {{ isLoadingTrackers ? "Cargando..." : "ğŸ¯ Listar trackers" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage && !trackers.length">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage && trackers.length">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="trackers.length">
      <article class="tracker" *ngFor="let tracker of trackers">
        <div class="tracker__header">
          <strong>{{ tracker.name }}</strong>
          <span class="badge">ID: {{ tracker.id }}</span>
        </div>
        <div class="tracker__details" *ngIf="tracker.default_status">
          <span><strong>Estado por defecto:</strong> {{ tracker.default_status.name }}</span>
        </div>
      </article>
    </div>

    <div class="no-results" *ngIf="!isLoadingTrackers && trackers.length === 0 && successMessage">
      <p>ğŸ“­ No se encontraron trackers disponibles.</p>
    </div>
  </section>

  <section class="card">
    <h2>Registrar ticket</h2>
    <div class="grid">
      <label>
        Project ID / Identifier
        <input
          type="text"
          [(ngModel)]="projectId"
          placeholder="1 o project-identifier"
          name="projectId"
        />
      </label>
      <label>
        Asignado a (opcional)
        <input
          type="text"
          [(ngModel)]="assignedToId"
          placeholder="ID del usuario"
          name="assignedToId"
        />
      </label>
      <label>
        Prioridad (opcional)
        <select [(ngModel)]="priorityId" name="priorityId">
          <option value="">-- Selecciona una prioridad --</option>
          <option *ngFor="let priority of priorities" [value]="priority.id">
            {{ priority.name }}{{ priority.is_default ? ' (Por defecto)' : '' }}
          </option>
        </select>
        <small *ngIf="!priorities.length">Haz clic en "âš¡ Listar prioridades" para cargar las opciones</small>
      </label>
      <label>
        CategorÃ­a (opcional)
        <select [(ngModel)]="categoryId" name="categoryId">
          <option value="">-- Selecciona una categorÃ­a --</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
        <small *ngIf="!categories.length">Ingresa el Project ID y haz clic en "ğŸ“‹ Listar categorÃ­as"</small>
      </label>
      <label>
        Tracker (opcional)
        <select [(ngModel)]="trackerId" name="trackerId">
          <option value="">-- Selecciona un tracker --</option>
          <option *ngFor="let tracker of trackers" [value]="tracker.id">
            {{ tracker.name }}
          </option>
        </select>
        <small *ngIf="!trackers.length">Haz clic en "ğŸ¯ Listar trackers" para cargar las opciones</small>
      </label>
      <label class="span-2">
        Subject
        <input
          type="text"
          [(ngModel)]="subject"
          placeholder="TÃ­tulo del ticket"
          name="subject"
        />
      </label>
      <label class="span-2">
        Description
        <textarea
          rows="4"
          [(ngModel)]="description"
          placeholder="Detalle del ticket"
          name="description"
        ></textarea>
      </label>
    </div>
    <button class="primary" (click)="createIssue()" [disabled]="isCreating">
      {{ isCreating ? "Creando..." : "Crear ticket" }}
    </button>
  </section>

  <section class="card">
    <h2>Consultar tickets</h2>

    <div class="filter-section">
      <h3>Filtros de bÃºsqueda</h3>

      <div class="grid">
        <label>
          Tipo de consulta
          <select [(ngModel)]="filterType" name="filterType">
            <option value="author">Creados por usuario</option>
            <option value="assigned">Asignados a usuario</option>
            <option value="all">Todos (sin filtro de usuario)</option>
          </select>
        </label>

        <label *ngIf="filterType !== 'all'">
          Usuario ID
          <input
            type="text"
            [(ngModel)]="filterUserId"
            placeholder="me, ID numÃ©rico o vacÃ­o"
            name="filterUserId"
          />
          <small
            >Usa "me" para ti mismo, un ID para otro usuario, o dÃ©jalo
            vacÃ­o</small
          >
        </label>

        <label>
          Estado (opcional)
          <input
            type="text"
            [(ngModel)]="filterStatusId"
            placeholder="open, closed, * o ID"
            name="filterStatusId"
          />
          <small
            >"open" = abiertos, "closed" = cerrados, "*" = todos, o ID
            especÃ­fico</small
          >
        </label>

        <label>
          Project ID (opcional)
          <input
            type="text"
            [(ngModel)]="filterProjectId"
            placeholder="ID o identifier del proyecto"
            name="filterProjectId"
          />
        </label>

        <label>
          LÃ­mite de resultados
          <input
            type="number"
            [(ngModel)]="limit"
            name="limit"
            min="1"
            max="100"
          />
        </label>
      </div>
    </div>

    <button class="secondary" (click)="fetchIssues()" [disabled]="isLoading">
      {{ isLoading ? "Consultando..." : "ğŸ” Consultar tickets" }}
    </button>

    <div class="messages">
      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    </div>

    <div class="list" *ngIf="issues.length">
      <article class="issue" *ngFor="let issue of issues">
        <div class="issue__header">
          <strong>#{{ issue.id }} - {{ issue.subject }}</strong>
          <span
            class="status"
            [class.status--open]="
              (issue.status?.name?.toLowerCase() || '').includes('new') ||
              (issue.status?.name?.toLowerCase() || '').includes('open')
            "
            [class.status--closed]="
              (issue.status?.name?.toLowerCase() || '').includes('closed') ||
              (issue.status?.name?.toLowerCase() || '').includes('resolved')
            "
          >
            {{ issue.status?.name || "Sin estado" }}
          </span>
        </div>
        <p class="issue__description" *ngIf="issue.description">
          {{ issue.description }}
        </p>
        <div class="issue__meta">
          <span><strong>Autor:</strong> {{ issue.author?.name || "N/A" }}</span>
          <span
            ><strong>Asignado:</strong>
            {{ issue.assigned_to?.name || "Sin asignar" }}</span
          >
          <span
            ><strong>Creado:</strong>
            {{ issue.created_on | date: "short" }}</span
          >
          <span *ngIf="issue.updated_on"
            ><strong>Actualizado:</strong>
            {{ issue.updated_on | date: "short" }}</span
          >
        </div>
      </article>
    </div>

    <div
      class="no-results"
      *ngIf="!isLoading && issues.length === 0 && successMessage"
    >
      <p>ğŸ“­ No se encontraron tickets con los filtros aplicados.</p>
    </div>
  </section>
</div>
